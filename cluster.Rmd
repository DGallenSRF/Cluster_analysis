---
title: "L04 Cluster"
output: html_notebook
---

```{r}
#knitr::opts_knit$set(root.dir = "C:/Users/Declan/Desktop/Data/R/Cluster_analysis")
knitr::opts_knit$set(root.dir = "H:/Projects/10000/10682/TS/Scenario Manager/Cluster Analysis/Cleaned")

library(tidyverse)
library(lubridate)
library(gridExtra)
library(reshape2)
library(zoo)
library(plotly)
```

##Read Data

Read data from Cluster Analysis Input Data.xlsx. From examining the file via Excel, we see that the data is located in the tab named "Database". We call that tab in the read_xlsx function.

```{r read data}
cluster_dat <- readxl::read_xlsx("Cluster Analysis Input Data.xlsx",sheet = 'Database')
```

Examine cluster_dat.

```{r structer of data}

str(cluster_dat)
```


First, we clean up the column headers by removing any potential trailing or leading spaces and replacing special characters in the strings with '_'.

```{r fix column names}

colnames(cluster_dat) <-trimws(colnames(cluster_dat))

colnames(cluster_dat) <-gsub('([[:punct:]])|\\s+','_',colnames(cluster_dat))

colnames(cluster_dat)
```

##DateTime

We look to fix the DateTime fields. The first five columns looks to be parsed versions of a DateTime. The 'Time Bin' looks to be the most complete DateTime variable. Examine further...

```{r check class of Time_Bin}
class(cluster_dat$Time_Bin)

cluster_dat$Time_Bin <- as.POSIXct(as.character(cluster_dat$Time_Bin),tz="US/Central")
```

```{r summary of Time_Bin}
summary(cluster_dat$Time_Bin)
table(is.na(cluster_dat$Time_Bin))
```

Everything seems to be in order. But we will keep an eye out for potential errors.

The last column is labelled week. Explore:

```{r summary of weeks}
summary(cluster_dat$Week)

```

Week 53 does not look right. Lets investigate further.

```{r check week 53}
cluster_dat[cluster_dat$Week==53,c(1:5,length(cluster_dat))]

```

Week 53 represents the last day of the year.

##Traffic Incidents

###Incidents
```{r}
summary(cluster_dat$Incident_Count)
```

```{r}
hist(cluster_dat$Incident_Count,breaks = 30)
```

Majority of days have no incidents.  

Explore the content of Incident Impact

```{r}
summary(cluster_dat$Incident_Impact)

par(mfrow=c(2,2))

hist(cluster_dat$Incident_Impact,breaks=seq(0,40,1),
     xlab='Incident_Impact')

plot(cluster_dat$Incident_Count[cluster_dat$Incident_Count!=0],cluster_dat$Incident_Impact[cluster_dat$Incident_Count!=0],
     xlab="Incident_Count",ylab='Incident_Impact')

plot(cluster_dat$Time_Bin[cluster_dat$Incident_Count!=0],cluster_dat$Incident_Count[cluster_dat$Incident_Count!=0],
     xlab="Time",ylab='Incident_Count')

plot(cluster_dat$Density[cluster_dat$Incident_Count!=0],cluster_dat$Incident_Count[cluster_dat$Incident_Count!=0],
     xlab="Density",ylab='Incident_Count')
```

It appears that the incident count measures the amount on incidents in a specific time bin. The incident impact tracks how many impacts happened in a specific time_bin. This will allow us to determine how bad each time_bin is in terms of incidents.  

There are no easily detectable patterns when plotting incidents vs time but we do see a strong positive correlation between Density and Incidents counts. This makes sense as intuitively the more cars, the more incidents. 

###Roadwork

```{r}
summary(cluster_dat$Roadwork_Count)
```

```{r}
table(cluster_dat$Roadwork_Count)
```

```{r roadwork plots}
par(mfrow=c(2,2))

hist(cluster_dat$Roadwork_Count[cluster_dat$Roadwork_Count!=0],xlab='Roadwork_Impact',main='Roadwork_Count')

plot(cluster_dat$Roadwork_Count[cluster_dat$Roadwork_Count!=0],cluster_dat$Roadwork_Impact[cluster_dat$Roadwork_Count!=0],
     xlab="Roadwork_Count",ylab='Roadwork_Impact')

plot(cluster_dat$Time_Bin[cluster_dat$Roadwork_Count!=0],cluster_dat$Roadwork_Count[cluster_dat$Roadwork_Count!=0],
     xlab="Time",ylab='Roadwork_Count')

plot(cluster_dat$Density[cluster_dat$Roadwork_Count!=0],cluster_dat$Roadwork_Count[cluster_dat$Roadwork_Count!=0],
     xlab="Density",ylab='Roadwork_Count')

```

```{r Roadwork Duration}

x <- as.numeric(format(cluster_dat$Roadwork_Duration,"%H"))
x <- x[x>0]
table(x)
```


Majority of days have no Roadwork. One really bad day with 7. No obvious outliers. 



##Metrics

Lets look at the Density, Volume, Speed variables. Again there are columns without names mixed in between these fields. We will ignore the unnamed variables.

###Date Time Fields

```{r create date time fields}
cluster_dat <- cluster_dat %>%
  mutate(Hour = format(Time_Bin,"%H"),
         Minute = format(Time_Bin,"%M"),
         Weekday = weekdays(cluster_dat$Time_Bin),
         Week = lubridate::week(cluster_dat$Time_Bin),
         Month = months(cluster_dat$Time_Bin),
         YearDay = yday(cluster_dat$Time_Bin))%>%
  filter(Hour == 14)%>%
  as.data.frame()




cluster_dat$Weekday <-  factor(cluster_dat$Weekday,levels=c("Sunday", "Monday", 
    "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
cluster_dat$Month <- factor(cluster_dat$Month,levels=c("January","February","March",
               "April","May","June","July","August","September",
               "October","November","December"),ordered=TRUE)
```


###Density

```{r density explore}
summary(cluster_dat$Density)

br_dens <- seq(0,50,2)
ranges_dens = paste(head(br_dens,-1), br_dens[-1], sep=" - ")
freq_dens <- hist(cluster_dat$Density, breaks=br_dens, include.lowest=TRUE, plot=FALSE)

freq_table_dens <-  data.frame(data.frame(range = ranges_dens, frequency = freq_dens$counts))
freq_table_dens[order(-freq_table_dens$frequency),]

plot(freq_dens)
```

The histogram is right skewed but no major outliers are present. There are also no 0 or NA values. 

We now plot the Density vs Time.

```{r weekday vs density}

ggplot(cluster_dat,aes(x=Weekday,y=Density,color=Weekday))+
  geom_violin()+
  geom_jitter(alpha=0.25)
```

Again, there do not seem to major outliers. There looks to be some patterns here. 

The Density is obviously lower on weekends compared to weekdays.




###Volume

```{r volume explore}
summary(cluster_dat$Volume)

br_vol <- seq(0,600000,20000)
ranges_vol = paste(head(br_vol,-1), br_vol[-1], sep=" - ")
freq_vol <- hist(cluster_dat$Volume, breaks=br_vol, include.lowest=TRUE, plot=FALSE)

freq_table_vol <-  data.frame(data.frame(range = ranges_vol, frequency = freq_vol$counts))
freq_table_vol[order(-freq_table_vol$frequency),]

plot(freq_vol)

```

It appears that the bin 40,000-60,000 contains the most records.





Again some interesting patterns but no major outliers. 

We move on to speed....


###Speed

```{r speed explore}


summary(cluster_dat$Speed)

br_speed <- seq(30,100,2)
ranges_speed = paste(head(br_speed,-1), br_speed[-1], sep=" - ")
freq_speed <- hist(cluster_dat$Speed, breaks=br_speed, include.lowest=TRUE, plot=FALSE)

freq_table_speed <-  data.frame(data.frame(range = ranges_speed, frequency = freq_speed$counts))
freq_table_speed[order(-freq_table_speed$frequency),]

plot(freq_speed)


```

The speed plot looks more normal in shape than the previous distributions but does appear to have a left skew. Again there are no major outliers to be worried about nor are there are any 0 or NAs.

Lets plot speed vs time

```{r plot weekday vs volume}

means <-  aggregate(Speed~Weekday,cluster_dat,mean)
ggplot(cluster_dat,aes(x=Weekday,y=Speed))+
  geom_violin(aes(color=Weekday))+
  geom_jitter(aes(color=Weekday),alpha=0.25)+
  stat_summary(fun.y=mean, colour="#990000", geom="point", 
               shape=18, size=3,show_guide = FALSE)+
  geom_text(data=means, aes(label = paste('Mean:\n',round(Speed,2),sep=''), y = Speed + 2.5),size=3,fontface='bold')+
  ylab('Speed mph')+
  theme(legend.position="none")
```


```{r plot month vs volume}

means <-  aggregate(Speed~Month,cluster_dat,mean)
ggplot(cluster_dat,aes(x=Month,y=Speed))+
  geom_violin(aes(color=Month))+
  geom_jitter(aes(color=Month),alpha=0.25)+
  stat_summary(fun.y=mean, colour="#990000", geom="point", 
               shape=18, size=3,show_guide = FALSE)+
  geom_text(data=means, aes(label = paste('Mean:\n',round(Speed,2),sep=''), y = Speed + 2.5),color='darkred',size=3,fontface='bold')+
  ylab('Speed mph')+
  theme(legend.position="none")
```

Looks like we have some reduced speeds in the Summer months, maybe due to construction activities. 
There are also some slower days in the winter months which could very easily be due to bad weather. 
But there are no noticeable patterns. 

```{r}
ggplot(cluster_dat,aes(x=Week,y=Speed,color=Weekday))+
  geom_point(aplha=0.25)+
  geom_smooth()
```

Again we are seeing a pattern with reduced speeds on weekends. 

Lets look at public holidays:

```{r}
hols_2017 <- as.POSIXct(c('2017-01-02 14:00','2017-05-29 14:00','2017-07-03 14:00','2017-07-04 14:00','2017-09-04 14:00','2017-11-23 14:00','2017-11-24 14:00','2017-12-25 14:00'))
table(cluster_dat$Time_Bin %in% hols_2017)

cluster_dat$hols_2017 <- cluster_dat$Time_Bin %in% hols_2017

g <- ggplot(cluster_dat,aes(x=Weekday,y=Density))+
  geom_point(aes(alpha=0.25,color=hols_2017))
plotly::ggplotly(g)

s <- ggplot(cluster_dat,aes(x=Weekday,y=Speed))+
  geom_point(aes(alpha=0.25,color=hols_2017))
plotly::ggplotly(s)
```

Public holidays seem to be the weekdays with highest speeds.



###Weather

```{r add cumulative minutes for weather}
##add 1 or 0 if there was a weather event
cluster_dat_melt <- reshape2::melt(cluster_dat,id.vars="Time_Bin",measure.vars=colnames(cluster_dat)[11:16])%>%
  mutate(Hrs = as.numeric(format(value,"%H")),
         Mins = as.numeric(format(value,"%M")))%>%
  mutate(total = Hrs*60+Mins)%>%
  group_by(Time_Bin)%>%
  summarise(sum = sum(total))
  
cluster_dat$weather <- cluster_dat_melt$sum
#cluster_dat$weather <- ifelse(cluster_dat_melt$sum>0,1,0)
```


##K Means Clustering

```{r kmeans}

set.seed(25)


##filter out the weekends
'%ni%' <- Negate('%in%')
cluster_dat_midweek <- cluster_dat %>% 
  filter(Weekday %ni% c('Saturday','Sunday'))

#run kmeans
speed_cluster <-  kmeans(cluster_dat_midweek%>%select(Speed,YearDay,weather)%>%scale(),centers = 5,nstart = 10)

##add cluster to fitlered dataframe
cluster_dat_midweek$cluster <- as.factor(speed_cluster$cluster)

plotly::plot_ly(cluster_dat_midweek,x=~YearDay,y=~Speed,color=~cluster,mode='markers',text=~paste('Weekday:',Weekday))

plotly::plot_ly(cluster_dat_midweek,x=~YearDay,y=~Speed,z=~weather,color=~cluster,hoverinfo='text',
                text = ~paste('Speed:', round(Speed,2), '<br>Weather mins:', weather, '<br>Time_Bin:', format(Time_Bin,"%Y-%m-%d")))%>% 
  add_markers()%>%
    layout(scene = list(xaxis = list(title = 'Day of Year'),
                     yaxis = list(title = 'Speed MPH'),
                     zaxis = list(title = 'Weather mins')))


ggplot(cluster_dat_midweek,aes(x=YearDay,y=Speed,color=cluster))+
  geom_point()+
  facet_wrap(~Weekday,scales='free')+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

```{r}
table(cluster_dat$Month)
```


